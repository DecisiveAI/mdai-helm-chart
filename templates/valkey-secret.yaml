{{- $valkey_passwd := randAlphaNum 32 -}}

---
apiVersion: v1
kind: Secret
metadata:
  name: valkey-secret
  labels:
    app: valkey
  annotations:
    "helm.sh/hook": pre-install
type: Opaque
data:
  VALKEY_PASSWORD: {{ $valkey_passwd | b64enc | quote }}
  VALKEY_ENDPOINT: {{ printf "%s-valkey-primary.%s.svc.cluster.local:%d" .Release.Name .Release.Namespace (int .Values.valkey.primary.service.ports.valkey) | b64enc | quote }}
---
apiVersion: v1
kind: Secret
metadata:
  name: grafana-redis-datasource
  labels:
    grafana_datasource: "1"
  annotations:
    "helm.sh/hook": pre-install
type: Opaque
stringData:
  redis-datasource.yaml: |
    apiVersion: 1
    datasources:
      - name: Valkey
        type: redis-datasource
        access: proxy
        orgId: 1
        version: 1
        url: redis://mdai-valkey-primary:6379
        password: {{ $valkey_passwd }}
        jsonData:
          poolSize: 5
          timeout: 10
          pingInterval: 0
          pipelineWindow: 0
        secureJsonData:
          password:  {{ $valkey_passwd  }}   
        editable: true
